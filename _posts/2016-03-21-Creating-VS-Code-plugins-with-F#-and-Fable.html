---
layout: post
title: "Creating VS Code plugins with F# and Fable"
description: "Creating VS Code plugins with F# and Fable"
modified: 2016-03-01
tags: [F#, Fable, VSCode, VS Code]
image:
  feature: abstract-4.jpg
---
<h1>Introduction</h1>
<p><a href="https://code.visualstudio.com/">VS Code</a> is new text editor (or rather lightweight IDE) created by Microsoft. Because it is product based on <a href="http://electron.atom.io/">Electron</a> - cross platform engine allowing developers to write desktop applications using web technologies - its plugin system supports JavaScript (and TypeScript). Unfortunately both those languages are not nice choice for someone using statically typed functional programming languages like F#. Up to this moment in my VS Code extensions I was using F# library called <a href="http://funscript.info/">FunScript</a> which compiles F# code to JavaScript. Whereas it sounds nice, library has some problems which makes writing code using it not nice experience. Fortunately recently, <a href="https://twitter.com/alfonsogcnunez">Alfonso Garcia-Caro</a>, one of contributors to FunScript, has decided to create new project compiling F# to JS (with <a href="https://babeljs.io/">Babel</a> as middle step) called <a href="https://github.com/fsprojects/Fable">Fable</a> which hopefully will solve some of the FunScript's problems. I have decided to investigate how this new library can be used to create VS Code plugins... using VS Code to code and compile those plugins.</p>
<h1>Requirements</h1>
<p>You need to have <a href="http://fsharp.org/">F# 4</a> and <a href="https://nodejs.org/en/">node.js</a> installed. Node has to be included in your <code>$PATH</code>.</p>
<h1>Initial steps</h1>
<p>The simplest way to start building own VS Code plugin is using <a href="http://yeoman.io/">Yeoman</a> to scaffold plugin project. Install Yeoman and <a href="https://code.visualstudio.com/docs/tools/yocode">VS Code Plugin Generator</a> using following commands:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">npm</span> <span class="i">install</span> <span class="o">-</span><span class="i">g</span> <span class="i">yo</span>
<span class="i">npm</span> <span class="i">install</span> <span class="o">-</span><span class="i">g</span> <span class="i">generator</span><span class="o">-</span><span class="i">code</span>
</code></pre></td>
</tr>
</table>
<p>The Yeoman generator will walk you through the steps required to create your customization or extension prompting for the required information. To launch the generator type the following in a command prompt:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">yo</span> <span class="i">code</span>
</code></pre></td>
</tr>
</table>
<p>We pick <code>New Extension (JavaScript)</code> option, go through all questions, and let Yeoman do its magic. After process is finished we enter newly created folder.Here we have to remove some unnecessary things generated by Yeoman - <code>extension.js</code> file, and <code>typing</code> and <code>tests</code> folders (who need tests anyway ;) ). We add <code>out/</code> entry to <code>.gitignore</code> files - all output files will be generated as part of our build process and shouldn't be commited to GitHub. Final step is creating empty <code>src</code> folder - it will contain our F# source files.</p>
<h1>Installing Fable and setting project.</h1>
<p>Installing Fable and VS Code bindings for it is easy - all things are published as npm modules. So we can just run following commands to add those tools to our project</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">npm</span> <span class="i">install</span> <span class="o">--</span><span class="i">save</span><span class="o">-</span><span class="i">dev</span> <span class="i">fable</span><span class="o">-</span><span class="i">compiler</span>
<span class="i">npm</span> <span class="i">install</span> <span class="o">--</span><span class="i">save</span><span class="o">-</span><span class="i">dev</span> <span class="i">fable</span><span class="o">-</span><span class="i">import</span> <span class="i">fable</span><span class="o">-</span><span class="i">import</span><span class="o">-</span><span class="i">vscode</span>
</code></pre></td>
</tr>
</table>
<p>Next step is updating our <code>package.json</code> file to include changes we have done and to create build targets which will compile F# code to JS.First of all we update <code>main</code> entry - it defines where is our entry file of plugin.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="s">&quot;main&quot;</span><span class="o">:</span> <span class="s">&quot;./out/extension&quot;</span>,
</code></pre></td>
</tr>
</table>
<p>Second, we update <code>scripts</code> part - here we define possible build targets which can be used for our project.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="s">&quot;scripts&quot;</span><span class="o">:</span> {
    <span class="s">&quot;build&quot;</span><span class="o">:</span> <span class="s">&quot;fable src/extension.fsx --outDir ../out -m --env node&quot;</span>,
    <span class="s">&quot;postbuild&quot;</span><span class="o">:</span> <span class="s">&quot;node src/fix_code.js&quot;</span>
  },
</code></pre></td>
</tr>
</table>
<blockquote>
<p>For more details about Fabel and compiler options please visit - <a href="https://github.com/fsprojects/Fable">https://github.com/fsprojects/Fable</a></p>
</blockquote>
<p><code>build</code> target runs fable compiler to generate JS from our F# file.
<code>postbuild</code> targets runs small node script which performs some additional operations to transform Fable output to required by VS Code form.</p>
<p><code>src/fix_code.js</code> file content:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">require</span>(<span class="s">&quot;fs&quot;</span>)<span class="o">.</span><span class="i">appendFile</span>(<span class="s">&quot;out/extension.js&quot;</span>, <span class="s">&quot;\nexports.activate = exports.default.activate&quot;</span>)
</code></pre></td>
</tr>
</table>
<h1>Writing F# Code</h1>
<blockquote>
<p>For more details about VS Code extension API please visit - <a href="https://code.visualstudio.com/docs/extensions/overview">https://code.visualstudio.com/docs/extensions/overview</a></p>
</blockquote>
<p>At last we can write some F# code. Our sample extension will be simple - it will be just Hello World.To start in <code>src</code> folder we create F# script file called <code>extension.fs</code>. First step is referencing Fable core library and VS Code bindings</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#r</span> <span class="s">&quot;../node_modules/fable-import/Fable.Import.dll&quot;</span>
<span class="prep">#load</span> <span class="s">&quot;../node_modules/fable-import-vscode/Fable.Import.VSCode.fs&quot;</span>
 
<span class="k">open</span> <span class="i">Fable</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">Core</span>
<span class="k">open</span> <span class="i">Fable</span><span class="o">.</span><span class="i">Import</span>
<span class="k">open</span> <span class="i">Fable</span><span class="o">.</span><span class="i">Import</span><span class="o">.</span><span class="i">vscode</span>
</code></pre></td>
</tr>
</table>
<p>Entry point of any VS Code plugin is activate function placed in file defined as entry point in <code>package.json</code>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">activate</span> (<span class="i">context</span> <span class="o">:</span> <span class="i">vscode</span><span class="o">.</span><span class="i">ExtensionContext</span>) <span class="o">=</span> 
    <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">printfn</span> <span class="s">&quot;Hello world&quot;</span>
    
    <span class="i">vscode</span><span class="o">.</span><span class="i">commands</span><span class="o">.</span><span class="i">Globals</span><span class="o">.</span><span class="i">registerCommand</span>(<span class="s">&quot;extension.sayHello&quot;</span>, <span class="k">fun</span> _ <span class="k">-&gt;</span>
        <span class="i">vscode</span><span class="o">.</span><span class="i">window</span><span class="o">.</span><span class="i">Globals</span><span class="o">.</span><span class="i">showInformationMessage</span> <span class="s">&quot;Hello world!&quot;</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="i">unbox</span> )
    <span class="o">|&gt;</span> <span class="i">context</span><span class="o">.</span><span class="i">subscriptions</span><span class="o">.</span><span class="i">Add</span>
    
    
</code></pre></td>
</tr>
</table>
<p>As we can see we can use both standard F# construct like <code>printfn</code> function (which is mapped to JS <code>console.log</code>) and functions defined in VS Code bindings. Here we print "Hello world" to console and register command which will display Hello World information in the popup. Now from console, we can run <code>npm build</code> and compile our F# script to JavaScript. We shall see result in <code>out</code> directory.</p>
<h1>Integration with VS Code</h1>
<p>Now, when we have set up project and can compile it, we need to integrate our solution with VS Code - first we define Task to run our build script from inside editor.
In <code>.vscode</code> folder we create <code>tasks.json</code> file and put there:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">{
	<span class="s">&quot;version&quot;</span><span class="o">:</span> <span class="s">&quot;0.1.0&quot;</span>,
	<span class="s">&quot;command&quot;</span><span class="o">:</span> <span class="s">&quot;npm&quot;</span>,
	<span class="s">&quot;isShellCommand&quot;</span><span class="o">:</span> <span class="k">true</span>,
	<span class="s">&quot;tasks&quot;</span><span class="o">:</span> [
		{
			<span class="s">&quot;taskName&quot;</span><span class="o">:</span> <span class="s">&quot;run&quot;</span>,
			<span class="s">&quot;isBuildCommand&quot;</span><span class="o">:</span> <span class="k">true</span>,
            <span class="s">&quot;args&quot;</span><span class="o">:</span> [ <span class="s">&quot;build&quot;</span> ]
		}
	]
}
</code></pre></td>
</tr>
</table>
<p>It's just simple task running <code>npm run build</code> - it is defined as build command which means it can be run using <code>Ctrl+Shift+B</code> command. Next step is setting this target as task we want to invoke before we start debugging. To do this, we open <code>launch.json</code> file and append <code>"preLaunchTask": "run"</code> to <code>Lanunch Extension</code> configuration (we can remove <code>Launch test</code> entry, we do not need tests anyway ;) ). Pressing F5 will run our extension - we can try it out by running <code>Hello World</code> command in Command Palette.</p>
<h1>Summary</h1>
<p>In this post we have shortly moved all steps necessary to create VS Code extension using F# and Fable. From my short experience with this tool it looks like it is much nicer option than FunScript, hopefully I will be able to port my other extensions to it! Whole source code of this sample application is on GitHub - <a href="https://github.com/Krzysztof-Cieslak/vscode-fable-demo">https://github.com/Krzysztof-Cieslak/vscode-fable-demo</a></p>


<div class="tip" id="fs1">namespace Microsoft.FSharp.Core</div>
<div class="tip" id="fs2">val printfn : format:Printf.TextWriterFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.printfn</div>
<div class="tip" id="fs3">val unbox : value:obj -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.unbox</div>
